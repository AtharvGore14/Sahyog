{% extends 'base.html' %}

{% block title %}Enhanced Locations - Sahayog Route Optimizer{% endblock %}

{% block extra_css %}
<style>
    .location-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }
    .location-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .location-card.high-priority { border-left-color: #dc3545; }
    .location-card.medium-priority { border-left-color: #ffc107; }
    .location-card.low-priority { border-left-color: #28a745; }
    .location-card.urgent-priority { border-left-color: #6f42c1; }
    
    .map-container {
        height: 400px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }
    .filter-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .location-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .marker-high { background-color: #dc3545; }
    .marker-medium { background-color: #ffc107; }
    .marker-low { background-color: #28a745; }
    .marker-urgent { background-color: #6f42c1; }
    
    .bulk-actions {
        background: #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .location-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }
    .analytics-widget {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .cluster-info {
        background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        color: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-map-marker-alt me-2"></i>
        Enhanced Locations
        <span class="badge bg-primary ms-2">{{ total_locations }} Total</span>
    </h1>
    <div class="btn-toolbar">
        <div class="btn-group me-2">
            <button class="btn btn-outline-secondary" onclick="toggleView()">
                <i class="fas fa-th me-2"></i>Toggle View
            </button>
        </div>
        <div class="btn-group">
            <a class="btn btn-primary" href="{% url 'route_optimizer:add_location' %}">
                <i class="fas fa-plus me-2"></i>Add Location
            </a>
        </div>
    </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <h3>{{ total_locations }}</h3>
            <p class="mb-0">Total Locations</p>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <h3>{{ high_priority_count }}</h3>
            <p class="mb-0">High Priority</p>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <h3>{{ active_routes_count }}</h3>
            <p class="mb-0">Active Routes</p>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <h3>{{ coverage_area|floatformat:1 }} kmÂ²</h3>
            <p class="mb-0">Coverage Area</p>
        </div>
    </div>
</div>

<!-- Enhanced Filter Panel -->
<div class="filter-panel">
    <div class="row">
        <div class="col-lg-3 col-md-6 mb-2">
            <input class="form-control" id="searchInput" placeholder="Search locations..." onkeyup="filterLocations()">
        </div>
        <div class="col-lg-2 col-md-6 mb-2">
            <select class="form-select" id="typeFilter" onchange="filterLocations()">
                <option value="">All Types</option>
                <option value="bin">Waste Bin</option>
                <option value="collection_point">Collection Point</option>
                <option value="depot">Depot</option>
                <option value="landfill">Landfill</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-2">
            <select class="form-select" id="priorityFilter" onchange="filterLocations()">
                <option value="">All Priorities</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-2">
            <select class="form-select" id="statusFilter" onchange="filterLocations()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="maintenance">Maintenance</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6 mb-2">
            <div class="btn-group w-100">
                <button class="btn btn-outline-primary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                </button>
                <button class="btn btn-primary" onclick="exportLocations()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="bulk-actions">
    <div class="row align-items-center">
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label class="form-check-label" for="selectAll">
                    Select All Locations
                </label>
            </div>
        </div>
        <div class="col-md-6">
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="bulkEdit()" disabled id="bulkEditBtn">
                    <i class="fas fa-edit me-1"></i>Bulk Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()" disabled id="bulkDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Bulk Delete
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="createRouteFromSelected()" disabled id="createRouteBtn">
                    <i class="fas fa-route me-1"></i>Create Route
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    <!-- Locations List/Grid -->
    <div class="col-lg-8">
        <div class="analytics-widget">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Locations
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="setViewMode('grid')" id="gridViewBtn">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="setViewMode('list')" id="listViewBtn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            
            <!-- Grid View -->
            <div id="gridView" class="location-grid">
                {% for location in locations %}
                <div class="location-card {{ location.priority }}-priority" data-location-id="{{ location.id }}">
                    <div class="form-check">
                        <input class="form-check-input location-checkbox" type="checkbox" value="{{ location.id }}">
                    </div>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">{{ location.name }}</h6>
                        <span class="badge bg-{% if location.priority == 'urgent' %}danger{% elif location.priority == 'high' %}warning{% elif location.priority == 'medium' %}info{% else %}success{% endif %}">
                            {{ location.get_priority_display }}
                        </span>
                    </div>
                    <p class="text-muted small mb-2">{{ location.address }}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-secondary">{{ location.get_location_type_display }}</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewLocation({{ location.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editLocation({{ location.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteLocation({{ location.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-weight-hanging me-1"></i>
                            {{ location.estimated_waste_volume }}L
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- List View -->
            <div id="listView" class="d-none">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllTable" onchange="toggleSelectAll()"></th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Address</th>
                                <th>Volume</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location in locations %}
                            <tr>
                                <td><input type="checkbox" class="location-checkbox" value="{{ location.id }}"></td>
                                <td>{{ location.name }}</td>
                                <td><span class="badge bg-secondary">{{ location.get_location_type_display }}</span></td>
                                <td><span class="badge bg-{% if location.priority == 'urgent' %}danger{% elif location.priority == 'high' %}warning{% elif location.priority == 'medium' %}info{% else %}success{% endif %}">{{ location.get_priority_display }}</span></td>
                                <td>{{ location.address }}</td>
                                <td>{{ location.estimated_waste_volume }}L</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewLocation({{ location.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="editLocation({{ location.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteLocation({{ location.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map and Analytics -->
    <div class="col-lg-4">
        <!-- Interactive Map -->
        <div class="analytics-widget">
            <h5 class="mb-3">
                <i class="fas fa-map me-2"></i>
                Location Map
            </h5>
            <div id="locationsMap" class="map-container"></div>
        </div>
        
        <!-- Location Clusters -->
        <div class="cluster-info">
            <h6 class="mb-2">
                <i class="fas fa-layer-group me-2"></i>
                Location Clusters
            </h6>
            <div class="row text-center">
                <div class="col-4">
                    <div class="mb-2">
                        <i class="fas fa-circle text-warning"></i>
                        <div class="small">High Priority</div>
                        <strong>{{ high_priority_count }}</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="mb-2">
                        <i class="fas fa-circle text-info"></i>
                        <div class="small">Medium Priority</div>
                        <strong>{{ medium_priority_count }}</strong>
                    </div>
                </div>
                <div class="col-4">
                    <div class="mb-2">
                        <i class="fas fa-circle text-success"></i>
                        <div class="small">Low Priority</div>
                        <strong>{{ low_priority_count }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Chart -->
        <div class="analytics-widget">
            <h6 class="mb-3">
                <i class="fas fa-chart-pie me-2"></i>
                Location Distribution
            </h6>
            <canvas id="locationChart" height="200"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let locationsMap;
let locationChart;
let currentViewMode = 'grid';

// Location data
const locations = {{ locations|safe }};

$(document).ready(function() {
    initializeMap();
    initializeChart();
    setupEventListeners();
});

function initializeMap() {
    locationsMap = L.map('locationsMap').setView([20.5937, 78.9629], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(locationsMap);

    // Add location markers
    locations.forEach(location => {
        const color = getPriorityColor(location.priority);
        const marker = L.circleMarker([location.latitude, location.longitude], {
            radius: 8,
            fillColor: color,
            color: 'white',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(locationsMap);
        
        marker.bindPopup(`
            <strong>${location.name}</strong><br>
            Type: ${location.location_type}<br>
            Priority: ${location.priority}<br>
            Volume: ${location.estimated_waste_volume}L
        `);
    });
}

function initializeChart() {
    const ctx = document.getElementById('locationChart').getContext('2d');
    locationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Waste Bins', 'Collection Points', 'Depots', 'Landfills'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: ['#667eea', '#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function getPriorityColor(priority) {
    switch(priority) {
        case 'urgent': return '#6f42c1';
        case 'high': return '#dc3545';
        case 'medium': return '#ffc107';
        case 'low': return '#28a745';
        default: return '#6c757d';
    }
}

function setupEventListeners() {
    // Checkbox change listeners
    $('.location-checkbox').change(function() {
        updateBulkActions();
    });
}

function filterLocations() {
    const searchTerm = $('#searchInput').val().toLowerCase();
    const typeFilter = $('#typeFilter').val();
    const priorityFilter = $('#priorityFilter').val();
    const statusFilter = $('#statusFilter').val();
    
    $('.location-card').each(function() {
        const card = $(this);
        const name = card.find('h6').text().toLowerCase();
        const type = card.find('.badge.bg-secondary').text().toLowerCase();
        const priority = card.find('.badge').not('.bg-secondary').text().toLowerCase();
        
        let show = true;
        
        if (searchTerm && !name.includes(searchTerm)) show = false;
        if (typeFilter && !type.includes(typeFilter)) show = false;
        if (priorityFilter && !priority.includes(priorityFilter)) show = false;
        
        if (show) {
            card.show();
        } else {
            card.hide();
        }
    });
}

function clearFilters() {
    $('#searchInput').val('');
    $('#typeFilter').val('');
    $('#priorityFilter').val('');
    $('#statusFilter').val('');
    filterLocations();
}

function toggleSelectAll() {
    const isChecked = $('#selectAll').is(':checked');
    $('.location-checkbox').prop('checked', isChecked);
    updateBulkActions();
}

function updateBulkActions() {
    const selectedCount = $('.location-checkbox:checked').length;
    const hasSelection = selectedCount > 0;
    
    $('#bulkEditBtn').prop('disabled', !hasSelection);
    $('#bulkDeleteBtn').prop('disabled', !hasSelection);
    $('#createRouteBtn').prop('disabled', !hasSelection);
    
    if (hasSelection) {
        $('#createRouteBtn').html(`<i class="fas fa-route me-1"></i>Create Route (${selectedCount})`);
    } else {
        $('#createRouteBtn').html('<i class="fas fa-route me-1"></i>Create Route');
    }
}

function setViewMode(mode) {
    currentViewMode = mode;
    
    if (mode === 'grid') {
        $('#gridView').removeClass('d-none');
        $('#listView').addClass('d-none');
        $('#gridViewBtn').addClass('active');
        $('#listViewBtn').removeClass('active');
    } else {
        $('#gridView').addClass('d-none');
        $('#listView').removeClass('d-none');
        $('#gridViewBtn').removeClass('active');
        $('#listViewBtn').addClass('active');
    }
}

function toggleView() {
    setViewMode(currentViewMode === 'grid' ? 'list' : 'grid');
}

function viewLocation(id) {
    // In real implementation, this would open a location details modal
    alert(`View location ${id}`);
}

function editLocation(id) {
    // In real implementation, this would open an edit form
    alert(`Edit location ${id}`);
}

function deleteLocation(id) {
    if (confirm('Are you sure you want to delete this location?')) {
        // In real implementation, this would delete the location
        alert(`Delete location ${id}`);
    }
}

function bulkEdit() {
    const selectedIds = $('.location-checkbox:checked').map(function() {
        return $(this).val();
    }).get();
    
    if (selectedIds.length > 0) {
        alert(`Bulk edit ${selectedIds.length} locations`);
    }
}

function bulkDelete() {
    const selectedIds = $('.location-checkbox:checked').map(function() {
        return $(this).val();
    }).get();
    
    if (selectedIds.length > 0 && confirm(`Are you sure you want to delete ${selectedIds.length} locations?`)) {
        alert(`Bulk delete ${selectedIds.length} locations`);
    }
}

function createRouteFromSelected() {
    const selectedIds = $('.location-checkbox:checked').map(function() {
        return $(this).val();
    }).get();
    
    if (selectedIds.length > 0) {
        // Redirect to optimize route with selected locations
        window.location.href = `{% url 'route_optimizer:optimize_route' %}?locations=${selectedIds.join(',')}`;
    }
}

function exportLocations() {
    // In real implementation, this would export locations to CSV/Excel
    alert('Exporting locations...');
}
</script>
{% endblock %}
